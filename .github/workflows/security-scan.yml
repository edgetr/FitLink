name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run secret scanner
        run: |
          chmod +x ./scripts/scan-secrets.sh
          ./scripts/scan-secrets.sh --all

      - name: Check for sensitive files
        run: |
          SENSITIVE_FILES=(
            "APIConfig.local.plist"
            "GoogleService-Info.plist"
            ".env"
            ".env.local"
          )
          
          FOUND=0
          for file in "${SENSITIVE_FILES[@]}"; do
            if git ls-files --error-unmatch "*/$file" "$file" 2>/dev/null; then
              echo "ERROR: Sensitive file '$file' is tracked in git!"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "Please remove these files from git tracking:"
            echo "  git rm --cached <file>"
            echo "  git commit -m 'Remove sensitive file from tracking'"
            exit 1
          fi
          
          echo "No sensitive files found in git tracking."

  gitleaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
